<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>Sticky Notes</title>

    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
      integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
      crossorigin="anonymous"
    />
    <link href="main.css" rel="stylesheet" />
  </head>
  <body>
    <div class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <div class="container d-flex justify-content-between">
        <a href="#" class="navbar-brand">Sticky Notes</a>
      </div>
    </div>

    <section class="jumbotron text-center">
      <div class="container">
        <h1 class="jumbotron-heading">Sticky Notes</h1>
        <p class="lead text-muted">Simply add a note and save rainforests!</p>
        <p>
          <a href="#" class="btn btn-primary">Add a note</a>
        </p>
      </div>
    </section>

    <div class="board text-muted">
      <div class="container">
        <div class="row">
          <div class="note">
            <div class="note-header">
              <h5 class="modal-title">Sticky note 1.</h5>
            </div>
            <div class="note-body">
              <p class="note-text" contenteditable="true">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
                eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut
                enim ad minim veniam, quis nostrud exercitation ullamco laboris
                nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor
                in reprehenderit in voluptate velit esse cillum dolore eu fugiat
                nulla pariatur. Excepteur sint occaecat cupidatat non proident,
                sunt in culpa qui officia deserunt mollit anim id est laborum.
              </p>
            </div>
            <div class="note-footer">
              <button type="button" class="close" aria-label="Delete">
                <span
                  aria-hidden="true"
                  class="fa fa-trash-o text-danger"
                ></span>
              </button>
            </div>
          </div>
          <div class="note">
            <div class="note-header">
              <h5 class="modal-title">Sticky note 2.</h5>
            </div>
            <div class="note-body">
              <p class="note-text" contenteditable="true">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
                eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut
                enim ad minim veniam, quis nostrud exercitation ullamco laboris
                nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor
                in reprehenderit in voluptate velit esse cillum dolore eu fugiat
                nulla pariatur. Excepteur sint occaecat cupidatat non proident,
                sunt in culpa qui officia deserunt mollit anim id est laborum.
              </p>
            </div>
            <div class="note-footer">
              <button type="button" class="close" aria-label="Delete">
                <span
                  aria-hidden="true"
                  class="fa fa-trash-o text-danger"
                ></span>
              </button>
            </div>
          </div>
          <div class="note">
            <div class="note-header">
              <h5 class="modal-title">Sticky note 3.</h5>
            </div>
            <div class="note-body">
              <p class="note-text" contenteditable="true">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
                eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut
                enim ad minim veniam, quis nostrud exercitation ullamco laboris
                nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor
                in reprehenderit in voluptate velit esse cillum dolore eu fugiat
                nulla pariatur. Excepteur sint occaecat cupidatat non proident,
                sunt in culpa qui officia deserunt mollit anim id est laborum.
              </p>
            </div>
            <div class="note-footer">
              <button type="button" class="close" aria-label="Delete">
                <span
                  aria-hidden="true"
                  class="fa fa-trash-o text-danger"
                ></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="text-muted">
      <div class="container">
        <p class="float-right">
          <a href="#">Back to top</a>
        </p>
        <p>&copy; Salvum Ligna Inc.</p>
      </div>
    </footer>
    <script>
      (function() {
        let newElement;
        const url = "/api/notes/";
        let prevText = " ";
        let data = {};
        let id = null;
        let serverData = {};
        const noteContainer = document.querySelector('.row');
        let count =0;

        for(let i=0; i<3;i++){
          document.querySelector('.row').firstElementChild.remove();
        }

        fetch("/api/notes")
          .then(function(response) {
            return response.json();
          })
          .then(function(myJson) {
            serverData = myJson;
            for(let i=0; i<serverData.length;i++){
            let noteClass = document.createElement("div");
            noteClass.classList.add('note');
            let noteHeader = document.createElement("div");
            noteHeader.classList.add("note-header");
            let modalTitle = document.createElement("h5");
            modalTitle.classList.add("modal-title");
            modalTitle.textContent = "Sticky Notes " + i;
            noteHeader.appendChild(modalTitle);
            let noteBody = document.createElement("div");
            noteBody.classList.add("note-body");
            let noteText = document.createElement("p");
            noteText.classList.add("note-text");
            noteText.contentEditable = true;
            noteText.setAttribute("data-id",serverData[i]._id);
            noteText.textContent = serverData[i].note;
            noteBody.appendChild(noteText);
            let noteFooter = document.createElement("div");
            noteFooter.classList.add("note-footer");
            let deleteButton = document.createElement("button");
            deleteButton.classList.add("close");
            deleteButton.setAttribute("aria-label","Delete");
            deleteButton.setAttribute("data-id",serverData[i]._id);
            let spanElememt = document.createElement("span");
            spanElememt.setAttribute("aria-hidden", true);
            spanElememt.classList.add("fa.fa-trash-o.text-danger");
            deleteButton.appendChild(spanElememt);
            noteFooter.appendChild(deleteButton);
            noteClass.appendChild(noteHeader);
            noteClass.appendChild(noteBody);
            noteClass.appendChild(noteFooter);
            noteContainer.appendChild(noteClass);
            count = count+1;

          }

          });

         
        const closeButton = document.querySelectorAll(".close");

        function deleteNote(element) {
          if (element.getAttribute("data-id") === null) {
            element.parentNode.parentNode.remove();
          } else {
            deleteURL = url + element.getAttribute("data-id");
            fetch(deleteURL, {
              method: "DELETE",
              body: JSON.stringify(data),
              headers: {
                "Content-Type": "application/json"
              }
            })
              .then(res => res.json())
              .then(function(response) {
                element.parentNode.parentNode.remove();
              })
              .catch(error => console.error("Error:", error));
          }
        }

        for (
          let i = 0;
          i < document.querySelectorAll(".note-text").length;
          i++
        ) {
          document
            .querySelectorAll(".note-text")
            [i].addEventListener("click", e => {
              newElement = e.target;
              prevText = newElement.textContent;
            });
        }

        for (let i = 0; i < closeButton.length; i++) {
          closeButton[i].addEventListener("click", () => {
            deleteNote(closeButton[i]);
          });
        }

        document
          .querySelector(".btn.btn-primary")
          .addEventListener("click", e => {
            count = count +1;
            var clone1 = document.querySelectorAll(".note")[
              document.querySelectorAll(".note").length - 1
            ];
            var clone3 = clone1.cloneNode(true);
            clone3.firstElementChild.firstElementChild.textContent =
              "Sticky Notes " + count;
            clone3.childNodes[3].firstElementChild.textContent = " ";

            clone3.childNodes[3].firstElementChild.addEventListener(
              "click",
              e => {
                newElement = e.target;
                prevText = newElement.textContent;
              }
            );
            clone3.childNodes[3].firstElementChild.removeAttribute("data-id");
            clone3.childNodes[3].firstElementChild.parentNode.nextElementSibling.firstElementChild.removeAttribute(
              "data-id"
            );
            clone1.insertAdjacentElement("afterend", clone3);
            clone3.childNodes[3].firstElementChild.parentNode.nextElementSibling.firstElementChild.addEventListener(
              "click",
              () => {
                deleteNote(
                  clone3.childNodes[3].firstElementChild.parentNode
                    .nextElementSibling.firstElementChild
                );
              }
            );
          });
        // console.log(newElement);

        document.addEventListener("click", function(event) {
          // console.log(newElement);
          if (newElement !== undefined) {
            var isClickInside = newElement.contains(event.target);
            //   console.log("tset");

            if (!isClickInside) {
              getData(newElement);
              //     console.log(newElement.getAttribute("data-id"));
              if (newElement.getAttribute("data-id") === null) {
                //   console.log("loop");
                fetch(url, {
                  method: "POST",
                  body: JSON.stringify(data),
                  headers: {
                    "Content-Type": "application/json"
                  }
                })
                  .then(res => res.json())
                  .then(function(response) {
                    id = response._id;

                    newElement.setAttribute("data-id", id);
                    newElement.parentNode.nextElementSibling.firstElementChild.setAttribute(
                      "data-id",
                      id
                    );
                  })
                  .catch(error => console.error("Error:", error));

                prevText = getData(newElement);
              } else if (newElement.getAttribute("data-id") !== null) {
                //console.log("loop");
                let newURL = url + newElement.getAttribute("data-id");

                if (prevText != getData(newElement)) {
                  // console.log("New Data " + getData(newElement));
                  //  console.log("Prev Data " + prevText);
                  fetch(newURL, {
                    method: "PUT",
                    body: JSON.stringify(data),
                    headers: {
                      "Content-Type": "application/json"
                    }
                  })
                    .then(res => res.json())
                    .then(response => JSON.stringify(response))
                    .catch(error => console.error("Error:", error));
                  prevText = getData(newElement);
                }
              }
            }
          }
        });

        /* function prevData(element) {
                    prevText = element.textContent;
                    return prevText;
                  } */
        function getData(element) {
          let newData = element.textContent;
          data = {
            note: newData
          };
          return newData;
        }
      })();
    </script>
  </body>
</html>
